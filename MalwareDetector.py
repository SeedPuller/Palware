#!/usr/bin/python3

import re
import os

alfa = r"(alfa[_[a-z]+)|(base64_[a-z]+\()|(_+z[a-zA-z0-9]+cg\()"

public_Malware_detect = r"(ini_[s]*[g]*[et]*[a-z]*)|(eval\()|([a-z]*[_]*exe[c]*)|(system\()|(php_uname\()|(safe_mode)|([a-z]*passthru\()"

keywords = r"(sym[link]*)|(copy\()|(move_uploaded_file)"

weevely = r"([b][a-zA-z0-9_\-|{}!%\^&@\*+]*[d]*[e]{1}\()"

defacement = r"(hacked)|(bypass)|(shell)"

otherScripts = r"(#![\/a-zA-z0-9]*bin\/[a-zA-z0-9]*)"

formatallow = [".php",".jpg",".png",".mp4",".html",".htm",".jpeg",".txt",".css",".psd",".sql",".zip",".js",".doc",".mo",".po"]

editAbleF = [".php",".html",".htm",".txt",".js"]

malware = []

def listDir(dirs):

    Dirs = []

    for Dir in os.listdir(dirs):

        if(os.path.isdir(Dir)):

            Dirs.append(Dir)

    return Dirs

def listfile(dirs):
    files = []

    for item in os.listdir(dirs):
        if(os.path.isdir(item)):
              pass
        else:
            files.append(dirs + "/" + item)

    return files

def checkfile(dirs,hard,internal):
    global malware
    global formatallow
    global editAbleF
    global alfa
    global public_Malware_detect
    global keywords
    global weevely
    global defacement
    global otherScripts

    if(internal == "y"):
        internal = True
    else:
        internal = False

    if(hard == "y"):
        hard = True
    else:
        hard = False

    files = listfile(dirs)

    for item in files:
        if os.path.isfile(item):
            print(item)
            FileInfo = os.path.splitext(item)
            if(FileInfo[1] in formatallow):
                if(FileInfo[1] in editAbleF):
                    check = open(item,"r")
                    code = check.read()
                    if(re.search(alfa,code,re.IGNORECASE) != False):
                         malware.append(item)
                    elif(re.search(public_Malware_detect,code,re.IGNORECASE) != False):
                         malware.append(item)
                    elif(re.search(keywords,code,re.IGNORECASE) != False):
                         malware.append(item)
                    elif(re.search(defacement,code,re.IGNORECASE) != False):
                        malware.append(item)
                    elif(re.search(otherScripts,code,re.IGNORECASE) != False):
                        malware.append(item)
                    elif(re.search(weevely,code,re.IGNORECASE) != False and hard == True):
                        malware.append(item)

                    check.close()

            else:
                malware.append(item)



    if internal == True:
        for eachDir in listDir(dirs):
            print(eachDir)
            #checkfile(eachDir,hard,"y")
    else:
        print("No internal")

def checkSfile(file_name):
    global malware
    global formatallow
    global editAbleF
    global alfa
    global public_Malware_detect
    global keywords
    global weevely
    global defacement
    global otherScripts

    fileInfo = os.path.splitext(file_name)
    if(fileInfo[1] in formatallow):
        if(fileInfo[1] in editAbleF):
            check = open(file_name,"r")
            code = check.read()

            if(re.search(alfa,code,re.IGNORECASE) != False):
                malware.append("[*] Malware Detected !")
            elif(re.search(public_Malware_detect,code,re.IGNORECASE) != False):
                malware.append("[*] Malware Detected !")
            elif(re.search(keywords,code,re.IGNORECASE) != False):
                malware.append("[*] Malware Detected !")
            elif(re.search(defacement,code,re.IGNORECASE) != False):
                malware.append("[*] Malware Detected !")
            elif(re.search(otherScripts,code,re.IGNORECASE) != False):
                malware.append("[*] Malware Detected !")
            elif(re.search(weevely,code,re.IGNORECASE) != False and hard == True):
                malware.append("[*] Malware Detected !")

                check.close()
        else:
             malware.append("[+] File Is Not ScanAble !")
    else:
        malware.append("[+] File Is Malware Cause Of The Extension !")

print("\033[31m┌─────────────────────────────────────────────────┐\n│                                                 │\n│ m    m            #           mm            m   │\n│ ##  ##  mmm    mmm#           ##   m mm   mm#mm │\n│ # ## # \"   #  #\" \"#          #  #  #\"  #    #   │ \n| #   "" # m\"\"\"#  #   #          #mm#  #   #    #   │\n│ #    # \"mm\"#  \"#m##         #    # #   #    \"mm │\n│                                                 │\n│                                                 │\n└─────────────────────────────────────────────────┘\n\033[m")

print("\033[32m [+]  PHP Malware Scanner Ver 0.6\n\n")

type = input("\033[31m [?] \033[m Please Select Your Scan Type : \n\n 1- Scan All Files In a Directory \n 2- Scan Simple File \n")

if(type == str(1)):
    dir_name = input("\033[31m [?] \033[m Enter Directory Name For Scan (Enter '.' for scan current dir) : \n ")
    if(os.path.isdir(dir_name) == False):
        print("\033[31m No Directory Found !")
        exit()
    hard = input("\033[31m [?] \033[m Hardcore Scan ? [y] or [n] (while this is active , app my make mistake ) : \n")
    internal = input("\033[31m [?] \033[m Check Internal Directories ? [y] or [n]) : \n ")

    checkfile(dir_name,hard,internal)

    print("[+] Malware Names Are  --> ")

else:
    file_name = input("\033[31m [?] \033[m Please Enter Your File Name(With Path) : \n")
    checkSfile(file_name)



print ("\033[37m [+]  Scan Started ...\n\033[m")


for malwares in malware:
    pass
    #print(malwares)




import subprocess,re,sys
green = "\033[32m"
normal = "\033[m"
red = "\033[31m"
white = "\033[37m"
orange = "\033[33m"
print("%s ┌─────────────────────────────────────────────────┐\n│                                                 │\n│ m    m            #           mm            m   │\n│ ##  ##  mmm    mmm#           ##   m mm   mm#mm │\n│ # ## # \"   #  #\" \"#          #  #  #\"  #    #   │ \n| #   "" # m\"\"\"#  #   #          #mm#  #   #    #   │\n│ #    # \"mm\"#  \"#m##         #    # #   #    \"mm │\n│                                                 │\n│                                                 │\n└─────────────────────────────────────────────────┘\n %s"%(red,normal))
print(" %s [+]  PHP Malware Scanner Ver 1.2\n\n%s"%(green,normal))
directory = ""
internal = ""
unsafef = ""
uploadfunc = ""
uploadform = ""
filemanage = ""
extensions = ""
filename = "mal_detect.py"
def startapp(directory,internal,unsafef,uploadfunc,uploadform,filemanage,extensions):
    global filename
    if(bashexec("sudo nohup python3 %s -d %s %s %s %s %s %s %s &"%(filename,directory,internal,unsafef,uploadfunc,uploadform,filemanage,extensions))):
        return True
    else:
        return False
def stopapp():
    global filename
    regex = r"(root\s*[0-9]*[\s]*[0-9a-z. \/:]*-d)"
    psx = bashoutput("ps aux | grep \"sudo nohup python3 %s\" "%(filename))
    search = re.search(regex,psx,re.IGNORECASE)
    if(search != False):
        pid = int(search.group().split()[1])
        kill = bashoutput("sudo kill %d"%(pid))
        if("No such process" not in kill):
            return True
        else:
            return False
    else:
        return False


def bashexec(command):
    process = subprocess.Popen(command.split())
    if(process):
        return True
    else:
        return False

def bashoutput(bashc):
    bashErrRE = r"(\/bin\/sh: [0-9]*: [a-zA-Z0-9 !@#$%^&*()\[\]{}\-=+<>\/?.,:;'\"\\|_]*: not found)"
    bash = subprocess.getoutput(bashc)
    if(re.search(bashErrRE,bash,re.IGNORECASE)):
        return False
    else:
        return bash
def get_opt():
    global directory,internal,unsafef,uploadfunc,uploadform,filemanage,extensions,green,red,normal,orange,white
    optnum = input("%sAvailable Options : \n 1- Add scanning directory (required) "
          "\n 2- Change internal directory check OPT (Default = OFF)"
          " \n 3- Add files that has unsafe-functions to white list"
          " \n 4- Add files that has upload-functions to white list"
          " \n 5- Add files that has upload-forms to white list"
          " \n 6- Add files that has file-managing-functions to white list"
          " \n 7- Add files that has banned-extensions to white list"
          " \n 8- Start scanning in background"
          " \n 9- Stop scanning "
          " \n 10- Exit "
          "\n %s-->%s"%(white,red,normal))
    if(optnum.isdigit()):
        optnum = int(optnum)
    else:
        print("%s No Option found ! Please Enter an number \n %s"%(red,normal))
        get_opt()
    if(optnum == 1):
        directory = input("Enter directory name (for current directory enter ' . ') \n --> ")
        get_opt()
    elif(optnum == 2):
        internal = input("Check internal directory ? (y/n) \n --> ")
        get_opt()
    elif(optnum == 3):
        unsafef = input("Enter file(s) name : (separate each name with ' , ')")
        get_opt()
    elif(optnum == 4):
        uploadfunc = input("Enter file(s) name : (separate each name with ' , ')")
        get_opt()
    elif(optnum == 5):
        uploadform = input("Enter file(s) name : (separate each name with ' , ')")
        get_opt()
    elif(optnum == 6):
        filemanage = input("Enter file(s) name : (separate each name with ' , ')")
        get_opt()
    elif(optnum == 7):
        extensions = input("Enter file(s) name : (separate each name with ' , ')")
        get_opt()
    elif(optnum == 8):
        if(directory == ""):
            print("%s Please Define an directory for scan ! %s "%(red,normal))
            get_opt()
        if(internal == "y"):
            internal = "-i"
        if(unsafef != ""):
            unsafef = "-f %s"%(unsafef)
        if(uploadfunc != ""):
            uploadfunc = "-u %s"%(uploadfunc)
        if(uploadform != ""):
            uploadform = "-U %s"%(uploadform)
        if(filemanage != ""):
            filemanage = "-F %s"%(filemanage)
        if(extensions != ""):
            extensions = "-e %s"%(extensions)
        if(startapp(directory,internal,unsafef,uploadfunc,uploadform,filemanage,extensions)):
            print("%s Malware scanning started successfully ! %s"%(orange,normal))
            get_opt()
        else:
            print("Error While starting scan :(")
    elif(optnum == 9):
        if(stopapp()):
            print("%s Script Stoped successfully !%s"%(orange,normal))
            get_opt()
        else:
            print("%sError While starting scan :(%s"(red,normal))
            get_opt()
    elif(optnum == 10):
        sys.exit()
    else:
        print("No options found")
        get_opt()
get_opt()
